## 简介
> weave net 创建一个虚拟网络将跨主机，甚至局域网，云平台的容器连接到一起，并且彼此能够发现。仿佛都接入到同一个网络交换机上。  
容器提供的服务可以通过weave-net向外暴露。

### weave-net特性
+ 简化容器的网络配置
> 容器可以使用标准服务的经典端口（mysql-3306)，容器通过DNS查找服务的IP地址。

+ 服务发现
> 每个节点提供一个 “micro DNS” 服务，只需给容器起一个名字，所有的事情就完成了，包括负载均衡。

+ 不需要额外的集群层面的中央数据存储
> weavenet直接和Dockers的网络插件绑定，不需要外部存储服务

+ 可以同部分可连的网络服务环境交互
> 可以同非容器运行的服务连接

+ weave net很快
> 自动选择两台主机最短的路径，提供近乎本地服务一样快的吞吐率和延时性

+ 网络协议友好
> 可以使用Wireshark等抓包工具抓取wavenet的数据包进行分析

+ 安全性好
> TCP 连接，可以加密通信通道，所以可以在不可信任的网络环境里传输数据

+ 支持广播

+ NAT 穿透
> 无论是点对点的文件共享，IP音频，都得益于内建的NAT穿透。

+ 支持平台众多
> docker, k8s, ecs等等

### 理解weavenet
weavenet 由一些了的对等点组成，weavenet路由器存在于不同的主机上。每一个对等点都有一个唯一的名称，该名称
不会随意改变。

路由器彼此之间建立TCP连接，运行握手协议和交换拓扑信息，这些连接是加密的。  
对等点之间建立UDP连接，并且是全双工的，可以穿透网络防火墙。

weavenet在主机上创建网桥，容器连接到网桥上（veth pair）。容器提供IP和子网掩码，这些信息可由用户或者
weavenet的IP地址分配者来管理配置。

weavenet不同主机容器之间的路由包交换通过两种方式：
+ fast data path
> 完全在内核空间里执行，提供一个sleeve回调方法。过程是：非本地容器的包的目的地址呗内核抓取，并在
用户空间的weavenet路由器执行，然后通过UDP将包转发到目标主机的weave路由器上，最后目标主机在执行一次
逆过程。

weavenet路由器存储了其他主机的MAC地址，结合拓扑信息做路由决策，避免数据包在网络里广播

### weavenet路由器的sleeve封装
包封装结构
```
+-----------------------------------+
| Name of sending peer              |
+-----------------------------------+
| Frame 1: Name of capturing peer   |
+-----------------------------------+
| Frame 1: Name of destination peer |
+-----------------------------------+
| Frame 1: Captured payload length  |
+-----------------------------------+
| Frame 1: Captured payload         |
+-----------------------------------+
| Frame 2: Name of capturing peer   |
+-----------------------------------+
| Frame 2: Name of destination peer |
+-----------------------------------+
| Frame 2: Captured payload length  |
+-----------------------------------+
| Frame 2: Captured payload         |
+-----------------------------------+
|                ...                |
+-----------------------------------+
| Frame N: Name of capturing peer   |
+-----------------------------------+
| Frame N: Name of destination peer |
+-----------------------------------+
| Frame N: Captured payload length  |
+-----------------------------------+
| Frame N: Captured payload         |
+-----------------------------------+
```
发送者的名称可以让接收方标识出发送方的UDP数据包。名称后紧接着是元数据和payload，以及一个以上的数据帧
如果路由器抓取到多个目的地址一样的帧，会执行批处理进行快速处理。

### 对等点之间的通信拓扑
weave的对等点相互交换自己的拓扑信息，因此，所有的对等点都知道整个网络的拓扑结构

对等点之间通过TCP连接进行通信
+ 基于广播机制的生成树
+ 邻居发现机制

拓扑消息的发送时机
+ when a connection has been added 新的连接加入时
> 当一个新的对等点加入网络时，整个网络的拓扑信息会发送给他，同事，新连接的两端的增量消息也会在整个
网络里进行广播

+ when a connection has been marked as ‘established’ 当连接包标记为“已建立”
> 当远方某个对等点可以接受当前对等点的UDP数据时，广播当前本地点的信息

+ 连接被销毁
> 广播当前本地点的信息

+ 定时的广播
> 防止前面提到的事件别没有被所有的节点接收到，造成的网络不可达问题。

更新消息到达对等点，对等点会同自己的网络拓扑模型进行整合。添加不存在的对等点信息，更新版本更新的
对等点信息。

如果更新的消息里包好一个接收方位置的节点，整个更新消息就会被忽略。

#### 连接限制
为了减小拓扑的计算，可以配置单个对等点允许的最大连接数，默认是100，可以通过weave launch --connlimit=100
进行配置，如果使用kubernetes，可以配置CONN_LIMIT环境变量。
